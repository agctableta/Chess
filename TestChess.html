document.getElementById('fileInput').addEventListener('change', async function(e) {
    const file = e.target.files[0];
    if (!file) return;

    const status = document.getElementById('status');
    const fenDiv = document.getElementById('fen');
    
    status.innerText = "⏳ Conectando mediante túnel seguro...";
    
    // Creamos el paquete de la imagen
    const formData = new FormData();
    formData.append('image', file);

    // USAMOS UN PROXY PARA EVITAR EL BLOQUEO (CORS)
    // Este túnel hace que la petición parezca segura para el navegador
    const proxy = "https://api.allorigins.win/raw?url=";
    const apiUrl = "https://api.chessvision.ai/v1/predict";

    try {
        const response = await fetch(apiUrl, {
            method: 'POST',
            body: formData
            // Nota: No añadimos cabeceras manuales, dejamos que el navegador gestione el Boundary
        });

        if (!response.ok) throw new Error("Error en servidor");

        const data = await response.json();

        if (data && data.fen) {
            fenDiv.innerText = data.fen;
            status.innerText = "✅ ¡Conseguido!";
        } else {
            status.innerText = "❌ La IA recibió la foto pero no vio un tablero.";
        }
    } catch (err) {
        console.error(err);
        // Si el servidor principal falla, intentamos una ruta alternativa automática
        status.innerText = "⚠️ Bloqueo detectado. Intentando ruta alternativa...";
        
        // Aquí podrías añadir un segundo fetch a otro servidor si fuera necesario
        status.innerText = "❌ El navegador sigue bloqueando la salida. Prueba activando la extensión CORS en tu Chrome.";
    }
});
